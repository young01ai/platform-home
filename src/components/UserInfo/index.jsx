import { useState, useEffect, useCallback, useContext } from 'react'
import { getUserInfo } from "@/api/playground"
import { loginHandler, logoutHandler } from "@/api/login"
import './UserInfo.scss'
import Analytics, { setUserId } from '@/util/awsReport'
import { useTranslation } from 'react-i18next'

import { UserProvider, UserContext, UserDispatchContext } from './userInfoContext'

const DefaultIcon = () => <svg className='user-info-icon-default' xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" fill="none">
    <rect width="28" height="28" rx="14" fill="url(#paint0_linear_105_1641)" />
    <g filter="url(#filter0_d_105_1641)">
        <path fillRule="evenodd" clipRule="evenodd" d="M10.4063 9.54367C10.4063 7.55891 12.0152 5.94995 14 5.94995C15.9848 5.94995 17.5937 7.55891 17.5937 9.54367C17.5937 11.5284 15.9848 13.1374 14 13.1374C12.0152 13.1374 10.4063 11.5284 10.4063 9.54367ZM6.573 18.2462C6.573 16.2614 8.18195 14.6525 10.1667 14.6525H10.4934C10.6702 14.6525 10.8459 14.6805 11.0139 14.7353L11.8434 15.0062C13.2447 15.4637 14.7552 15.4637 16.1566 15.0062L16.986 14.7353C17.1541 14.6805 17.3298 14.6525 17.5066 14.6525H17.8333C19.8181 14.6525 21.427 16.2614 21.427 18.2462V19.385C21.427 20.1068 20.9038 20.7222 20.1914 20.8386C16.091 21.5081 11.909 21.5081 7.80853 20.8386C7.09613 20.7222 6.573 20.1068 6.573 19.385V18.2462Z" fill="white" />
    </g>
    <defs>
        <filter id="filter0_d_105_1641" x="2.75339" y="4.04015" width="22.4932" height="23.0298" filterUnits="userSpaceOnUse" colorInterpolationFilters="sRGB">
            <feFlood floodOpacity="0" result="BackgroundImageFix" />
            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
            <feOffset dy="1.9098" />
            <feGaussianBlur stdDeviation="1.9098" />
            <feComposite in2="hardAlpha" operator="out" />
            <feColorMatrix type="matrix" values="0 0 0 0 0.269333 0 0 0 0 0 0 0 0 0 0.841667 0 0 0 0.05 0" />
            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_105_1641" />
            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_105_1641" result="shape" />
        </filter>
        <linearGradient id="paint0_linear_105_1641" x1="0" y1="28" x2="28" y2="0" gradientUnits="userSpaceOnUse">
            <stop stopColor="#C0DDD6" />
            <stop offset="1" stopColor="#69C2B1" />
        </linearGradient>
    </defs>
</svg>
const LoginOutIcon = () => <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
    <mask id="path-1-outside-1_881_1449" maskUnits="userSpaceOnUse" x="1.5" y="1" width="14" height="14" fill="black">
        <rect fill="white" x="1.5" y="1" width="14" height="14" />
        <path fillRule="evenodd" clipRule="evenodd" d="M2.541 13.3284V12.321L2.54234 3.79315C2.53316 3.56474 2.54234 3.12802 2.54234 3.12802L2.54124 2.20024C2.54111 2.08969 2.63069 2 2.74124 2H3.51968H4.209H8.667C8.75541 2 8.84019 2.03538 8.9027 2.09835C8.96522 2.16133 9.00034 2.24674 9.00034 2.3358C9.00034 2.42485 8.96522 2.51027 8.9027 2.57324C8.84019 2.63621 8.75541 2.67159 8.667 2.67159H4.56034H3.8623H3.40645C3.29647 2.67159 3.20714 2.76031 3.20664 2.87028C3.20547 3.13256 3.20412 3.57814 3.20767 3.72398V13.1284C3.20767 13.2389 3.29721 13.3284 3.40767 13.3284H4.267H8.667C8.75541 13.3284 8.84019 13.3638 8.9027 13.4268C8.96522 13.4897 9.00034 13.5751 9.00034 13.6642C9.00034 13.7533 8.96522 13.8387 8.9027 13.9016C8.84019 13.9646 8.75541 14 8.667 14H4.361H3.51968H2.741C2.63055 14 2.541 13.9105 2.541 13.8V13.3284ZM14.4943 7.98266C14.4916 7.90425 14.4587 7.82994 14.4023 7.77533L11.9563 5.32866C11.8935 5.26794 11.8093 5.23435 11.7219 5.2351C11.6345 5.23586 11.5509 5.27092 11.4891 5.33272C11.4273 5.39453 11.3922 5.47813 11.3915 5.56553C11.3907 5.65293 11.4243 5.73713 11.485 5.8L13.3617 7.67733H6.20034C6.11194 7.67733 6.02715 7.71245 5.96464 7.77496C5.90213 7.83747 5.86701 7.92226 5.86701 8.01066C5.86701 8.09907 5.90213 8.18385 5.96464 8.24637C6.02715 8.30888 6.11194 8.344 6.20034 8.344H13.3617L11.485 10.2213C11.4243 10.2842 11.3907 10.3684 11.3915 10.4558C11.3922 10.5432 11.4273 10.6268 11.4891 10.6886C11.5509 10.7504 11.6345 10.7855 11.7219 10.7862C11.8093 10.787 11.8935 10.7534 11.9563 10.6927L14.4023 8.24666C14.4587 8.1918 14.4917 8.11727 14.4943 8.03866C14.4946 8.03809 14.4948 8.03753 14.4951 8.03697C14.4988 8.02834 14.5021 8.02072 14.4983 8.01133C14.4943 8.00133 14.4943 7.99266 14.4943 7.98266Z" />
    </mask>
    <path fillRule="evenodd" clipRule="evenodd" d="M2.541 13.3284V12.321L2.54234 3.79315C2.53316 3.56474 2.54234 3.12802 2.54234 3.12802L2.54124 2.20024C2.54111 2.08969 2.63069 2 2.74124 2H3.51968H4.209H8.667C8.75541 2 8.84019 2.03538 8.9027 2.09835C8.96522 2.16133 9.00034 2.24674 9.00034 2.3358C9.00034 2.42485 8.96522 2.51027 8.9027 2.57324C8.84019 2.63621 8.75541 2.67159 8.667 2.67159H4.56034H3.8623H3.40645C3.29647 2.67159 3.20714 2.76031 3.20664 2.87028C3.20547 3.13256 3.20412 3.57814 3.20767 3.72398V13.1284C3.20767 13.2389 3.29721 13.3284 3.40767 13.3284H4.267H8.667C8.75541 13.3284 8.84019 13.3638 8.9027 13.4268C8.96522 13.4897 9.00034 13.5751 9.00034 13.6642C9.00034 13.7533 8.96522 13.8387 8.9027 13.9016C8.84019 13.9646 8.75541 14 8.667 14H4.361H3.51968H2.741C2.63055 14 2.541 13.9105 2.541 13.8V13.3284ZM14.4943 7.98266C14.4916 7.90425 14.4587 7.82994 14.4023 7.77533L11.9563 5.32866C11.8935 5.26794 11.8093 5.23435 11.7219 5.2351C11.6345 5.23586 11.5509 5.27092 11.4891 5.33272C11.4273 5.39453 11.3922 5.47813 11.3915 5.56553C11.3907 5.65293 11.4243 5.73713 11.485 5.8L13.3617 7.67733H6.20034C6.11194 7.67733 6.02715 7.71245 5.96464 7.77496C5.90213 7.83747 5.86701 7.92226 5.86701 8.01066C5.86701 8.09907 5.90213 8.18385 5.96464 8.24637C6.02715 8.30888 6.11194 8.344 6.20034 8.344H13.3617L11.485 10.2213C11.4243 10.2842 11.3907 10.3684 11.3915 10.4558C11.3922 10.5432 11.4273 10.6268 11.4891 10.6886C11.5509 10.7504 11.6345 10.7855 11.7219 10.7862C11.8093 10.787 11.8935 10.7534 11.9563 10.6927L14.4023 8.24666C14.4587 8.1918 14.4917 8.11727 14.4943 8.03866C14.4946 8.03809 14.4948 8.03753 14.4951 8.03697C14.4988 8.02834 14.5021 8.02072 14.4983 8.01133C14.4943 8.00133 14.4943 7.99266 14.4943 7.98266Z" fill="black" fillOpacity="0.88" />
    <path d="M2.541 12.321H2.241V12.321L2.541 12.321ZM2.54234 3.79315L2.84234 3.7811L2.84234 3.7932L2.54234 3.79315ZM2.54234 3.12802L2.84241 3.12767L2.84227 3.13433L2.54234 3.12802ZM2.54124 2.20024L2.24124 2.20059V2.20059L2.54124 2.20024ZM8.9027 2.09835L8.68979 2.3097L8.68979 2.3097L8.9027 2.09835ZM8.9027 2.57324L8.68979 2.36189L8.68979 2.36189L8.9027 2.57324ZM3.20664 2.87028L2.90665 2.86894V2.86894L3.20664 2.87028ZM3.20767 3.72398L3.50767 3.71667V3.72398H3.20767ZM8.9027 13.4268L8.68979 13.6381L8.68979 13.6381L8.9027 13.4268ZM8.9027 13.9016L8.68979 13.6903L8.68979 13.6903L8.9027 13.9016ZM14.4023 7.77533L14.1935 7.99074L14.1902 7.98743L14.4023 7.77533ZM14.4943 7.98266L14.7943 7.97233V7.98266H14.4943ZM11.9563 5.32866L12.1648 5.11284L12.1685 5.11656L11.9563 5.32866ZM11.7219 5.2351L11.7245 5.53509H11.7245L11.7219 5.2351ZM11.4891 5.33272L11.2769 5.12059L11.2769 5.12059L11.4891 5.33272ZM11.3915 5.56553L11.6914 5.56814V5.56814L11.3915 5.56553ZM11.485 5.8L11.2728 6.01212L11.2692 6.00841L11.485 5.8ZM13.3617 7.67733L13.5738 7.46523L14.0858 7.97733H13.3617V7.67733ZM5.96464 7.77496L5.75251 7.56283L5.75251 7.56283L5.96464 7.77496ZM5.96464 8.24637L5.75251 8.4585L5.75251 8.4585L5.96464 8.24637ZM13.3617 8.344V8.044H14.0858L13.5738 8.55609L13.3617 8.344ZM11.485 10.2213L11.2692 10.0129L11.2728 10.0092L11.485 10.2213ZM11.3915 10.4558L11.6914 10.4532V10.4532L11.3915 10.4558ZM11.7219 10.7862L11.7245 10.4862H11.7245L11.7219 10.7862ZM11.9563 10.6927L12.1685 10.9048L12.1648 10.9085L11.9563 10.6927ZM14.4023 8.24666L14.1902 8.03451L14.1931 8.03168L14.4023 8.24666ZM14.4943 8.03866L14.1945 8.02849L14.1964 7.97224L14.2186 7.9205L14.4943 8.03866ZM14.4951 8.03697L14.2197 7.91795L14.2197 7.91792L14.4951 8.03697ZM14.4983 8.01133L14.7769 7.89991L14.7769 7.89992L14.4983 8.01133ZM2.841 12.321V13.3284H2.241V12.321H2.841ZM2.84234 3.7932L2.841 12.3211L2.241 12.321L2.24234 3.7931L2.84234 3.7932ZM2.54234 3.12802C2.84227 3.13433 2.84227 3.13432 2.84227 3.13432C2.84227 3.13432 2.84227 3.13432 2.84227 3.13433C2.84227 3.13433 2.84227 3.13435 2.84227 3.13437C2.84227 3.13441 2.84227 3.13447 2.84226 3.13457C2.84226 3.13475 2.84225 3.13504 2.84225 3.13543C2.84223 3.13621 2.84221 3.1374 2.84217 3.13897C2.84211 3.14212 2.84202 3.1468 2.84191 3.15288C2.84168 3.16502 2.84136 3.1827 2.84101 3.20466C2.8403 3.24861 2.83945 3.30953 2.83888 3.37743C2.83774 3.51515 2.83783 3.67493 2.84209 3.78111L2.24258 3.80519C2.23767 3.68296 2.23776 3.51017 2.2389 3.37243C2.23949 3.30261 2.24036 3.24007 2.24108 3.195C2.24145 3.17244 2.24177 3.15422 2.24201 3.14159C2.24213 3.13528 2.24223 3.13036 2.24229 3.12699C2.24233 3.12531 2.24235 3.12402 2.24237 3.12313C2.24238 3.12269 2.24239 3.12235 2.24239 3.12211C2.2424 3.12199 2.2424 3.1219 2.2424 3.12184C2.2424 3.1218 2.2424 3.12178 2.2424 3.12176C2.2424 3.12175 2.2424 3.12174 2.2424 3.12173C2.2424 3.12173 2.2424 3.12172 2.54234 3.12802ZM2.84124 2.19988L2.84234 3.12767L2.24234 3.12838L2.24124 2.20059L2.84124 2.19988ZM2.74124 2.3C2.79651 2.3 2.8413 2.25516 2.84124 2.19988L2.24124 2.20059C2.24091 1.92422 2.46487 1.7 2.74124 1.7V2.3ZM3.51968 2.3H2.74124V1.7H3.51968V2.3ZM4.209 2.3H3.51968V1.7H4.209V2.3ZM8.667 2.3H4.209V1.7H8.667V2.3ZM8.68979 2.3097C8.68337 2.30323 8.67513 2.3 8.667 2.3V1.7C8.83569 1.7 8.99702 1.76753 9.11562 1.887L8.68979 2.3097ZM8.70034 2.3358C8.70034 2.32559 8.69629 2.31625 8.68979 2.3097L9.11562 1.887C9.23414 2.0064 9.30034 2.16788 9.30034 2.3358H8.70034ZM8.68979 2.36189C8.69629 2.35534 8.70034 2.346 8.70034 2.3358H9.30034C9.30034 2.50371 9.23414 2.66519 9.11562 2.78459L8.68979 2.36189ZM8.667 2.37159C8.67513 2.37159 8.68337 2.36836 8.68979 2.36189L9.11562 2.78459C8.99702 2.90407 8.83569 2.97159 8.667 2.97159V2.37159ZM4.56034 2.37159H8.667V2.97159H4.56034V2.37159ZM3.8623 2.37159H4.56034V2.97159H3.8623V2.37159ZM3.40645 2.37159H3.8623V2.97159H3.40645V2.37159ZM2.90665 2.86894C2.90788 2.59338 3.13173 2.37159 3.40645 2.37159V2.97159C3.4612 2.97159 3.50639 2.92724 3.50664 2.87163L2.90665 2.86894ZM2.90776 3.73128C2.90407 3.57992 2.90548 3.12858 2.90665 2.86894L3.50664 2.87163C3.50545 3.13653 3.50416 3.57635 3.50758 3.71667L2.90776 3.73128ZM2.90767 13.1284V3.72398H3.50767V13.1284H2.90767ZM3.40767 13.6284C3.13153 13.6284 2.90767 13.4046 2.90767 13.1284H3.50767C3.50767 13.0732 3.4629 13.0284 3.40767 13.0284V13.6284ZM4.267 13.6284H3.40767V13.0284H4.267V13.6284ZM8.667 13.6284H4.267V13.0284H8.667V13.6284ZM8.68979 13.6381C8.68337 13.6316 8.67513 13.6284 8.667 13.6284V13.0284C8.83569 13.0284 8.99701 13.0959 9.11562 13.2154L8.68979 13.6381ZM8.70034 13.6642C8.70034 13.654 8.69629 13.6447 8.68979 13.6381L9.11562 13.2154C9.23414 13.3348 9.30034 13.4963 9.30034 13.6642H8.70034ZM8.68979 13.6903C8.69629 13.6838 8.70034 13.6744 8.70034 13.6642H9.30034C9.30034 13.8321 9.23414 13.9936 9.11562 14.113L8.68979 13.6903ZM8.667 13.7C8.67513 13.7 8.68337 13.6968 8.68979 13.6903L9.11562 14.113C8.99702 14.2325 8.83569 14.3 8.667 14.3V13.7ZM4.361 13.7H8.667V14.3H4.361V13.7ZM3.51968 13.7H4.361V14.3H3.51968V13.7ZM2.741 13.7H3.51968V14.3H2.741V13.7ZM2.841 13.8C2.841 13.7448 2.79623 13.7 2.741 13.7V14.3C2.46486 14.3 2.241 14.0761 2.241 13.8H2.841ZM2.841 13.3284V13.8H2.241V13.3284H2.841ZM14.6112 7.55995C14.7232 7.66858 14.7888 7.81638 14.7942 7.97234L14.1945 7.99299C14.1945 7.99213 14.1941 7.99131 14.1935 7.99071L14.6112 7.55995ZM12.1685 5.11656L14.6145 7.56323L14.1902 7.98743L11.7442 5.54077L12.1685 5.11656ZM11.7193 4.93512C11.8853 4.93367 12.0453 4.99751 12.1648 5.11288L11.7479 5.54445C11.7416 5.53838 11.7332 5.53502 11.7245 5.53509L11.7193 4.93512ZM11.2769 5.12059C11.3944 5.00317 11.5532 4.93656 11.7193 4.93512L11.7245 5.53509C11.7157 5.53517 11.7074 5.53868 11.7012 5.54486L11.2769 5.12059ZM11.0915 5.56292C11.0929 5.39686 11.1595 5.23802 11.2769 5.12059L11.7012 5.54485C11.695 5.55104 11.6915 5.5594 11.6914 5.56814L11.0915 5.56292ZM11.2692 6.00841C11.1539 5.88896 11.09 5.72898 11.0915 5.56292L11.6914 5.56814C11.6914 5.57688 11.6947 5.5853 11.7008 5.59158L11.2692 6.00841ZM13.1495 7.88942L11.2728 6.01209L11.6972 5.5879L13.5738 7.46523L13.1495 7.88942ZM6.20034 7.37733H13.3617V7.97733H6.20034V7.37733ZM5.75251 7.56283C5.87128 7.44406 6.03237 7.37733 6.20034 7.37733V7.97733C6.1915 7.97733 6.18302 7.98084 6.17677 7.98709L5.75251 7.56283ZM5.56701 8.01066C5.56701 7.84269 5.63373 7.6816 5.75251 7.56283L6.17677 7.98709C6.17052 7.99334 6.16701 8.00182 6.16701 8.01066H5.56701ZM5.75251 8.4585C5.63373 8.33972 5.56701 8.17863 5.56701 8.01066H6.16701C6.16701 8.01951 6.17052 8.02798 6.17677 8.03423L5.75251 8.4585ZM6.20034 8.644C6.03237 8.644 5.87128 8.57727 5.75251 8.4585L6.17677 8.03423C6.18302 8.04048 6.1915 8.044 6.20034 8.044V8.644ZM13.3617 8.644H6.20034V8.044H13.3617V8.644ZM11.2728 10.0092L13.1495 8.1319L13.5738 8.55609L11.6972 10.4334L11.2728 10.0092ZM11.0915 10.4584C11.09 10.2923 11.1539 10.1324 11.2692 10.0129L11.7008 10.4297C11.6947 10.436 11.6914 10.4444 11.6914 10.4532L11.0915 10.4584ZM11.2769 10.9007C11.1595 10.7833 11.0929 10.6245 11.0915 10.4584L11.6914 10.4532C11.6915 10.4619 11.695 10.4703 11.7012 10.4765L11.2769 10.9007ZM11.7193 11.0862C11.5532 11.0848 11.3944 11.0182 11.2769 10.9007L11.7012 10.4765C11.7074 10.4827 11.7157 10.4862 11.7245 10.4862L11.7193 11.0862ZM12.1648 10.9085C12.0453 11.0238 11.8853 11.0877 11.7193 11.0862L11.7245 10.4862C11.7332 10.4863 11.7416 10.4829 11.7479 10.4769L12.1648 10.9085ZM14.6145 8.4588L12.1685 10.9048L11.7442 10.4805L14.1902 8.03453L14.6145 8.4588ZM14.7942 8.04884C14.7889 8.20485 14.7234 8.35277 14.6116 8.46165L14.1931 8.03168C14.194 8.03083 14.1945 8.02969 14.1945 8.02849L14.7942 8.04884ZM14.7705 8.15598L14.7701 8.15682L14.2186 7.9205C14.2191 7.91941 14.2195 7.91837 14.2197 7.91795L14.7705 8.15598ZM14.7769 7.89992C14.8031 7.96547 14.8043 8.02948 14.7938 8.08253C14.7892 8.10583 14.7829 8.12431 14.7787 8.1356C14.7748 8.14605 14.7708 8.15523 14.7704 8.15601L14.2197 7.91792C14.2244 7.90714 14.2117 7.93327 14.2052 7.96634C14.1964 8.01107 14.1973 8.06658 14.2198 8.12274L14.7769 7.89992ZM14.7943 7.98266C14.7943 7.99585 14.7969 7.95005 14.7769 7.89991L14.2198 8.12275C14.1917 8.05261 14.1943 7.98947 14.1943 7.98266H14.7943Z" fill="black" fillOpacity="0.88" mask="url(#path-1-outside-1_881_1449)" />
</svg>

const UserInfo = () => {
    const { t } = useTranslation()

    const userContext = useContext(UserContext)
    const dispatch = useContext(UserDispatchContext)

    const getUserInfoRequest = useCallback(() => {
        getUserInfo().then(res => {
            // console.log('res', res)
            if (res.status === 0) {
                // setInfo(res.data)
                dispatch({
                    type: 'setUserInfo',
                    value: res.data
                })
                window && window.gtag('config', 'GA_MEASUREMENT_ID', {
                    'user_id': res.data.name
                })
                Analytics.updateEndpoint({
                    userId: res.data.name
                })
                setUserId(res.data.name)
                Analytics.record({
                    name: 'login'
                })
            }
        })
    })

    useEffect(() => {
        getUserInfoRequest()
    }, [])

    return <div className="user-info-header" data-login={!!userContext.login}>
        <div className='user-info-container' onClick={() => {
            if (userContext.login) {
                // console.log("test")
            } else {
                loginHandler()
            }
        }}>
            {userContext.name ? <div className="user-info-icon">{(userContext.name).substring(0, 1)}</div> : <DefaultIcon></DefaultIcon>}
            <div className="user-info-name">{userContext.name || t('header.notLogin')}</div>
        </div>
        <div className="user-info-hover">
            <div className="user-info-hover-item user-info-hover-item-user-info">
                {userContext.name ? <div className="user-info-icon">{(userContext.name).substring(0, 1)}</div> : <DefaultIcon></DefaultIcon>}
                <div className="user-info-text">
                    <div className="user-info-name">{userContext.name}</div>
                    {userContext.login ? <div className="user-info-login">{userContext.login}</div> : null}
                </div>
            </div>
            <div className="user-info-hover-item user-info-hover-item-log-out" onClick={() => {
                if (userContext.login) {
                    logoutHandler()
                } else {
                    //
                }
            }}>
                <LoginOutIcon></LoginOutIcon>
                <div>{t('header.logout')}</div>
            </div>
        </div>
    </div>
}

export default UserInfo